$(function() {
    // $('.appointment-form-new').show();
    //Показ формы
    $(document).on('click', '.open-appointment-form', function (e) {
        e.preventDefault();
        var formSelector = $('.form')
        formSelector[0].reset();


        // При открытии формы, заполняем типы клиента
        sendAjaxForm('getClienttype', '');
            
        if (response.result == 'success') {
            var clientTypesArr = response.data;
                
            addPreloader();
            resetSelects(selectType);
            clearOptions(selectType);
            createOptions(selectType, clientTypesArr);
            removeDisabled(selectType);
            removePreloader();
        }

        var officeId = $(this).data('office_id');
        $('select[name="UF_BRANCH"]').val(officeId);
        setTimeout(function() {
            $('select').trigger('refresh');
        }, 1)

        // var vacancy = $(this).closest('.spoiler');
        // var job = vacancy.find('.spoiler__title').text().trim();
        // var place = vacancy.find('.place-of-work').text().trim();
        // $('.input--vacancy').val(job).closest('.input__wrapper').addClass('full');
        // $('.input--place').val(place).closest('.input__wrapper').addClass('full');

        $('.appointment-form').fadeIn();
        $('body').addClass('body-overflow-hidden');

        $('.form__success').hide();
        $('.form__fields').show();

        formSelector.show(function(){
            $('.vacancy-form__popup .h3').show();
        });
        
    });


    function convDateforJs(userDate) {
        var from = userDate.split('.');
        var f = new Date(from[2], from[1], from[0]);
        var date_string = f.getFullYear() + '-' + ('0' + f.getMonth()).slice(-2) + '-' + ('0' + f.getDate()).slice(-2);
        return date_string;
    }

    var response, clientType, office, date, territory, subject;
    var formId = $('input[name="SM_FORM_ID"]').val();
    var selectType = $('select[name="UF_TYPE"]');
    var selectDistrict = $('select[name="UF_DISTRICT"]');
    var selectBranch = $('select[name="UF_BRANCH"]');
    var selectSubject = $('select[name="UF_SUBJECT"]');
    var selectDate = $('input[name="UF_DATE"]');
    var selectTime = $('select[name="UF_TIME"]');

    // Добавление прелоадера
    function addPreloader() {
        $('body').append('<div class="form__preloader"></div>');
    }

    // Удаление прелоадера
    function removePreloader() {
        setTimeout(function() {
            $('body').find('.form__preloader').remove();
        }, 400);
    }

    // Очищение нижестоящих селекто и датапикера
    function resetSelects($this) {
        var thisSelectIndex = $this.parents('.form__row').index();
        $('.appoinment-form-js select').each(function() {
            var select = $(this);
            if (select.parents('.form__row').index() > thisSelectIndex) {
                clearOptions(select);
                select.trigger('refresh');
                select.parents('.select-with-name').addClass('select-with-name--disabled');
            }
        });

        $('.appoinment-form-js .input--date').each(function() {
            var inputDate = $(this);
            if (inputDate.parents('.form__row').index() > thisSelectIndex) {
                inputDate.val('').prop('disabled', true).parent().removeClass('full');
            }
        });
    }

    // Отправка аякс запроса
    function sendAjaxForm(requestType, postData) {
        $.ajax({
            type: 'POST',
            url: '',
            data: {
                'CHECK_APPOINTMENT': 'Y',
                'SM_FORM_ID':  formId,
                'requestType': requestType,
                'postData': postData,
            },
            dataType: 'json',
            async: false
        }).done(function(res){
            response = res;
        });
    }

    // Удаление вариантов у селектов
    function clearOptions($this) {
        $($this).html('').append(
            '<option disabled selected>Не выбрано</option>'
        );
    }

    // Создание вариантов у селектов 
    function createOptions(select, data) {
        $.each(data, function(index, value) {
            select.append('<option value="' + index + '">' + value + '</option>');
        });
    }

    // Удаление класса неактивности
    function removeDisabled(selector) {
        setTimeout(function() {
            selector.trigger('refresh');
            selector.parents('.select-with-name').removeClass('select-with-name--disabled');
        }, 1);
    }

    // Показ ошибок
    function showError(errorSelector, nextSelector, text) {
        if (text !== null) {
            nextSelector.find('option').not(':first').remove();
            nextSelector.trigger('refresh');
            nextSelector.parents('.select-with-name').addClass('select-with-name--disabled');
            errorSelector.after('<label class="error">' + text + '</label>');
        }
    }


    // При выборе типа клиента, заполняем районы
    $(document).on('change', '.appoinment-form-js select[name="UF_TYPE"]', function() {
        clientType = $(this).val();

        addPreloader();
        resetSelects($(this));

        sendAjaxForm('getTerritories', '');
        
        if (response.result == 'success') {
            var districts = response.data;
            
            clearOptions(selectDistrict);
            createOptions(selectDistrict, districts);
            removeDisabled(selectDistrict);
            removePreloader();
        }
    });

    // При выборе района, заполняем офисы
    $(document).on('change', 'select[name="UF_DISTRICT"]', function() {
        territory = $(this).val();
        
        addPreloader();
        resetSelects($(this));

        var postData = {
            'territori': territory
        }
        sendAjaxForm('getOffices', postData);

        if (response.result == 'success') {
            var offices = response.data;
            
            clearOptions(selectBranch);
            createOptions(selectBranch, offices);
            removeDisabled(selectBranch);
            removePreloader();
        }
    });

    // При выборе офиса, заполняем темы
    $(document).on('change', '.appoinment-form-js select[name="UF_BRANCH"]', function() {
        office = $(this).val();

        addPreloader();
        resetSelects($(this));

        var postData = {
            'territori': territory,
            'office': office,
            'clienttype': clientType
        }
        sendAjaxForm('getThemes', postData);

        if (response.result) {
            var subjects = response.data;
            selectBranch.siblings('label.error').remove();

            if (typeof(subjects) == 'object') {
                clearOptions(selectSubject);
                createOptions(selectSubject, subjects);
                removeDisabled(selectSubject);
            } else {
                showError(selectBranch, selectSubject, subjects);
            }

            removePreloader();
        }
    });

    // При выборе темы, заполняем даты
    $(document).on('change', '.appoinment-form-js select[name="UF_SUBJECT"]', function() {
        subject = $(this).val();
        
        addPreloader();
        resetSelects($(this));

        var postData = {
            'territori': territory,
            'office': office,
            'clienttype': clientType,
            'theme': subject
        }
        sendAjaxForm('getDates', postData);

        if (response.result) {
            var datesRow = response.data;
            var dates = [];

            selectSubject.siblings('label.error').remove();

            if (typeof(datesRow) == 'object' && datesRow !== null) {
                $.each(datesRow,function(index,value){
                    dates.push(value);
                });

                $('.input--date').attr('date-events', dates);

                $('.input--date').each(function (e) {
                    var eventDates = $(this).attr('date-events');
                    var dateInput = $(this);

                    dateInput.datepicker('destroy');
                    dateInput.datepicker({
                        autoClose: true,
                        toggleSelected: false,
                        position: 'top left',
                        onRenderCell: function(date, cellType) {
                            var currentDate = date.toLocaleDateString('ru-RU');
                            if (cellType == 'day' && eventDates.indexOf(currentDate) != -1) {
                                return {disabled: false}
                            } else {
                                return {disabled: true}
                            }
                        },
                        /* onSelect: function() {
                            console.log('test');
                            addPreloader();
                        }, */
                        onHide: function(dp, animationCompleted) {
                            if (animationCompleted) {
                                addPreloader();
                                dateInput.trigger('change');
                            }
                        },
                    });
                });

                $('.input--date').val('').prop('disabled', false).parent().removeClass('full');
                $('.datepicker--cell-day.-selected-').removeClass('-selected-');
            } else {
                showError(selectSubject, selectDate, 'Отсутствуют даты для записи');
            }
            
            removePreloader();
        }
    });

    // При выборе даты, заполняем интервалы
    $(document).on('change', 'input[name="UF_DATE"]', function() {
        date = convDateforJs($(this).val());

        resetSelects($(this));

        var postData = {
            'territori': territory,
            'office': office,
            'clienttype': clientType,
            'theme': subject,
            'date': date,
        }
        sendAjaxForm('getTimes', postData);
        
        if (response.result) {
            var times = response.data;

            selectDate.siblings('label.error').remove();

            if (typeof(times) == 'object' && times !== null) {
                clearOptions(selectTime);
                createOptions(selectTime, times);
                removeDisabled(selectTime);
            } else {
                showError(selectDate, selectTime, times);
            }

            removePreloader();
        }
    });

    // Проверка даты
    $.validator.addMethod('validDate', function(value, element) {
        return this.optional(element) || /^\d{2}\.\d{2}\.\d{4}$/.test(value);
    }, 'Неправильный формат даты');

    // Показ формы
    $(document).on('click', '.open-appointment-form', function (e) {
        var formSelector = $('.form')
        formSelector[0].reset();

        var officeId = $(this).data('office_id');
        $('select[name="UF_BRANCH"]').val(officeId);
        setTimeout(function() {
            $('select').trigger('refresh');
        }, 1)

        // var vacancy = $(this).closest('.spoiler');
        // var job = vacancy.find('.spoiler__title').text().trim();
        // var place = vacancy.find('.place-of-work').text().trim();
        // $('.input--vacancy').val(job).closest('.input__wrapper').addClass('full');
        // $('.input--place').val(place).closest('.input__wrapper').addClass('full');

        $('.appointment-form').fadeIn();
        $('body').addClass('body-overflow-hidden');

        $('.form__success').hide();
        $('.form__fields').show();

        formSelector.show(function(){
            $('.vacancy-form__popup .h3').show();
        });
    });

    // Скрытие формы
    $(document).on('click', '.vacancy-form__close, .vacancy-form__overlay', function (e) {
        $('.appointment-form').fadeOut()
        $('body').removeClass('body-overflow-hidden');
    });

    // Календарь
    $('.input--date').datepicker();

    // Маска телефона
    $('.input--phone').each(function(){
        $(this).mask('+7 (999) 999-99-99', {placeholder: ' '});
    });

    // Плейсхолдеры
    function inputPlaceholder($this) {
        if($this.val() != '') {
            $this.closest('.form__label').addClass('filled');
        } else {
            $this.closest('.form__label').removeClass('filled');
        }
    }

    $('input, textarea').each(function() {
        inputPlaceholder($(this));
    });

    $('input, textarea').on('change keyup', function(){
        inputPlaceholder($(this));
    });

    // Валидация 
    $('.appoinment-form-js').validate({
        ignore: [],
        rules: {},
        messages: {},
        submitHandler: function() {   
            var formSelector = $('.appoinment-form-js')

            // указываем из какой формы брать данные
            var formData = new FormData(formSelector[0]);

            
            // отправляем запрос
            $.ajax({
                type: 'POST',
                url: '',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function(res){
                    formSelector.find('.form__errors').html('');  // зачищаем сообщения об ошибках

                    if (res.result == 'success') {
                        formSelector[0].reset();
                        setTimeout(function() {
                            $('select').trigger('refresh');
                        }, 1)
                        formSelector.find('.form__success span').text(res.talon);
                        formSelector.find('.form__success').show();
                        formSelector.find('.form__fields').hide();
                        formSelector.find('input[name="captcha_code"]').val(res.bx_capcha_code);
                        formSelector.find('input[name="captcha_word"]').val('');
                        formSelector.find('#captcha_img').attr('src', res.bx_capcha_img);
                    } else {
                        $.each(res.errors, function(key, value) {
                            formSelector.find('.form__errors').append('<p>' + value + '</p>');
                        });
                        
                        formSelector.find('input[name="captcha_code"]').val(res.bx_capcha_code);
                        formSelector.find('input[name="captcha_word"]').val('');
                        formSelector.find('#captcha_img').attr('src', res.bx_capcha_img);
                        
                    }
                },
                error: function (jqXHR, exception) {
                    var msg = '';

                    if (jqXHR.status === 0) {
                        msg = 'Отсутствует соединение с сервером';
                    } else if (jqXHR.status == 404) {
                        msg = 'Страница обработки запроса не найдена (404)';
                    } else if (jqXHR.status == 500) {
                        msg = 'Внутренняя ошибка сервера (500)';
                    } else if (exception === 'parsererror') {
                        msg = 'Не верный формат данных (JSON)';
                    } else if (exception === 'timeout') {
                        msg = 'Превышено время ответа сервера';
                    } else if (exception === 'abort') {
                        msg = 'Фоновый запрос прерван';
                    } else {
                        msg = 'Неопознанная ошибка.\n' + jqXHR.responseText;
                    }

                    formSelector.find('.form__errors').append('<p>' + msg + '</p>');
                    formSelector.find('input[name="captcha_code"]').val(res.bx_capcha_code);
                    formSelector.find('input[name="captcha_word"]').val('');
                    formSelector.find('#captcha_img').attr('src', res.bx_capcha_img);
                },

            });

            return false;
           
        }
    });

    $.extend($.validator.messages, {
        required: 'Обязательное поле',
        email: 'Неправильный формат почты'
    });
});